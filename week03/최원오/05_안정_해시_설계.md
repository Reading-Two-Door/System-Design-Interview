# 안정 해시 설계

- 수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요

## 해시 키 재배치 문제

- serverIndex = hsah(key) % 서버개수
- 서버 풀의 크기가 고정되어 있을 때, 데이터 분포가 균등할 때는 잘 작동하나 서버 추가나 삭제 시 문제가 발생한다.

## 안정 해시

- 해시 테이블 크기가 조정될 때 평균적으로 오직 k(키의 수)/n(슬롯의 수)개의 키만 재배치하는 해시 기술
- 전통적 해시 테이블은 슬롯의 수가 바뀌면 거의 대부분 키를 재배치한다.

### 해시 공간과 해시 링

해시 서버

- 서버 IP나 이름을 해시 링의 위치에 대응

해시 키

서버 조회

- 어떤 키가 저장되는 서버는 해당 키의 위치로 부터 시계 방향으로 링을 탐색하며 만나는 첫 번째 서버

서버 추가

- 서버를 추가하더라도 키 가운데 일부만 재배치 하면 된다. (새로 추가된 서버와 이전에 위치한 서버 사이에 위치한 키)

서버 제거

- 제거된 서버를 바라보던 키들만 시계 방향 가장 가까운 서버로 재배치

#### 기본 구현법의 두가지 문제

- 파티션(인접한 서버 사이의 해시 공간)의 크기를 균등하게 유지하는 게 불가능하다 (서버 마다 할당받는 공간의 크기가 달라짐)
- 키의 균등 분포를 달성하기 어렵다(가상 노드로 해결)

가상노드

- 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.
- 각 서버는 여러개의 파티션을 관리해야 한다.
- 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다. 표준 편차가 작아져 데이터가 고르게 분포되기 때문
- 가상 노드의 수를 늘릴수록 저장 공간은 더 많이 필요하므로 트레이드오프가 있다.

## 마치며

안정해시의 이점

- 서버 추가 및 삭제 시 재배치되는 키의 수가 최소화
- 수평적 규모 확장성을 달성하기 쉽다
- 핫스팟 키 문제를 줄인다.
