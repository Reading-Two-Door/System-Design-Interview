# 유튜브 설계

## 1단계 문제 이해 및 설계 범위 확정

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 가능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 안정성
- 앱, 웹, 스마트TV 지원

## 2단계 개략적 설계안 제시 및 동의 구하기

### 비디오 업로드 절차

- 비디오 업로드, 메타데이터 갱신 작업이 병렬적으로 수행

프로세스a: 비디오 업로드

1. 원본 저장소에 업로드
2. 트랜스코딩 서버는 원본 저장소에서 비디오를 가져와 트랜스코딩을 시작
3. a- 트랜드코딩이 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
4. b- 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
5. API서버가 단말에게 비디오 업로드가 끝나서 스트리밍 준비가 되었음을 알림

프로세스b: 메타데이터 갱신

- 파일 이름, 크기, 포맷 등의 메타데이터로 캐시와 데이터베이스를 업데이트

### 비디오 스트리밍 절차

- 스트리밍 프로토콜은 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법
- 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다.

## 3단계 상세 설계

### 비디오 트랜스 코딩

- 특정 포맷으로 저장된 비디오가 다른 단말에서도 순조롭게 재생되려면 호환되는 비트레이트와 포맷으로 저장되어야 한다.
- 비트레이트는 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지를 나타내는 단위다. 비트레이트가 높은 비디오는 일반적으로 고화질
- 인코딩 포맷
  - 컨테이너 - 메타데이터를 담는 바구니
  - 코덱 - 비디오 화질을 보존하면서 파일 크기를 줄일 압축 및 압축 해제 알고리즘

### 유향 비순환 그래프(DAG) 모델

- 각기 다른 유형의 비디오 프로세싱 파이프라인을 지원하는 한편 적절한 수준의 추상화를 도입하여 실행할 작업을 손수 정의할 수 있도록 해야한다.
- 원본 비디오는 비디오, 오디오, 메타데이터 세 부분으로 나누어 처리

비디오

- 검사 - 좋은 품질의 비디오인지, 손상은 없는지 확인하는 작업
- 비디오 인코딩 - 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩하는 작업
- 썸네일 - 자동 추출된 이미지로 썸네일을 만드는 작업
- 워터마크 - 비디오 식별정보를 이미지 위에 오버레이 형태로 띄워 표시하는 작업

### 비디오 트랜스코딩 아키텍처

전처리기

- 비디오 분할
  - 비디오 스트림을 GOP라 불리는 단위로 쪼갠다. GOP는 특정 순서로 배열된 프레임 그룹
  - 하나의 GOP는 독립적으로 재생 가능하며, 길이는 보통 몇 초 정도다.
  - 오래된 단말이나 브라우저는 GOP단위의 비디오 분할을 지원하지 않는다. 그런 단말의 경우 전처리기가 비디오 분할을 대신한다
- DAG 생성
  - 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만들어낸다.
- 데이터 캐시
  - 안정성을 높이기 위해 전처리기는 GOP와 메타데이터를 임시 저장소에 보관한다.
  - 비디오 인코딩이 실패하면 시스템은 보관된 데이터를 활용해 인코딩을 재개한다.

DAG 스케줄러

- DAG 그래프를 몇 개 단계로 분할한 다음에 그 각각을 자원관리자의 작업 큐에 집어 넣는다.

자원 관리자

- 자원 배분을 효과적으로 수행하는 역할
- 작업 큐 - 실행할 작업이 보관되어 있는 우선순위 큐
- 작업 서버큐 - 작업 서버의 가용 상태 정보가 보관되어있는 우선순위 큐
- 실행 큐 - 현재 실행 중인 작업 및 작업 서버 정보가 보관되어 있는 큐
- 작업 스케줄러 - 최적의 작업/서버 조합을 골라, 해당 작업 서버가 작업을 수행하도록 지시하는 역할

작업 서버

- DAG에 정의된 작업을 수행, 작업 종류에 따라 작업 서버도 구분하여 관리

임시 저장소

- 어떤 시스템을 사용할 것인가는 데이터의 유형, 크기, 이용 빈도, 데이터 유효기간 등에 따라 달라진다.
- 메타데이터는 크기가 작고 빈번히 참조되니 메모리에 캐시해두면 좋다.
- 비디오/오디오 데이터는 BLOB 저장소에 두는 것이 바람직

인코딩된 비디오

- 인코딩 파이프라인의 최종 결과물이다.

### 시스템 최적화

속도 최적화: 비디오 병렬 업로드

- 비디오 전부를 한 번의 업로드로 올리는 것은 비효율적
- 분할한 GOP를 병렬적으로 업로드하면 설사 일부가 실패해도 빠르게 업로드를 재개할 수 있다.

속도 최적화: 업로드 센터를 사용자 근거리에 지정

- 업로드 센터를 여러 곳에 두는 것
- CDN을 업로드 센터로 이용

속도 최적화: 모든 절차를 병렬화

- 느슨하게 결합된 시스템을 만들어서 병렬성을 높이는 것
- 메시지 큐를 도입해 이벤트 각각을 인코딩 모듈은 병력적으로 처리

안전성 최적화: 미리 사인된 업로드 URL

- 허가받은 사용자만이 올바른 장소에 비디오를 업로드할 수 있도록 하기 위해, pre-signed 업로드 URL을 이용

안전성 최적화: 비디오 보호

- 비디오의 저작권 보고
  - 디지털 저작권 관리 시스템 도입
  - AES 암호화 - 비디오를 암호화하고 접근 권한을 설정하는 방식, 암호화된 비디오는 재생 시에만 복호화
  - 워터마크 - 비디오 위에 소유자 정보를 포함하는 이미지 오버레이

비용 최적화

- 인기 비디오만 CDN 으로 제공
- 인기가 없는 비디오는 필요 시 인코딩하여 재생
- CDN을 직접 구축

오류처리

- 회복 가능 오류 - 재시도하고 계속 실패 시 클라이언트에게 적절한 오류 코드 반환
- 회복 불가능 오류 - 비디오에 대한 작업 중단 후 클라이언트에게 적절한 오류 코드 반환
- 업로드 오류 - 몇 회 재시도
- 비디오 분할 오류 - 전체 비디오를 서버로 전송하고 서버가 해당 비디오 분할을 처리하도록 처리
- 트랜스 코딩 오류 - 재시도
- 전처리 오류 - DAG 그래프를 재생성
- DAG 스케줄러 오류 - 작업을 다시 스케줄링
- 자원 관리자 큐에 장애 발생 - 사본을 이용
- 작업 서버 장애 - 다른 서버에서 해당 작업 재시도
- API 서버 장애 - 다른 API서버로 우회
- 메타데이터 캐시 서버 장애 - 데이터는 다중화되어 있으므로 다른 노드에서 데이터를 가져와 사용
- 메타데이터 데이터베이스 서버 장애 - 주 서버가 죽었다면 부 서버 가운데 하나를 주 서버로 교체

## 4단계 마무리

- API 계층의 규모 확장성 확보 방안
- 데이터베이스 계층의 규모 확장성 확보 방안
- 라이브 스트리밍
- 비디오 삭제
